/** * Project: Scratch Management Dashboard * Version: 3.0 (Rill Dinamis - Database Driven) * Description: Navigasi digenerate otomatis berdasarkan Role & Level ID dari database. */import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';import { supabaseUrl, supabaseKey } from './config.js';const supabase = createClient(supabaseUrl, supabaseKey);// --- 1. SELEKTOR ELEMEN & CONFIG ---const statsElements = {    sekolah: document.getElementById('count-sekolah'),    kelas: document.getElementById('count-kelas'),    siswa: document.getElementById('count-siswa')};const logoutBtn = document.getElementById('btn-logout');const semesterLabelEl = document.getElementById('semester-label');const menuContainer = document.getElementById('dynamic-menu-container');// Mapping nama kategori di Database ke Tampilan Judul & Class CSSconst CATEGORY_MAP = {    'sekolah': { title: 'Manajemen Sekolah (Reguler)', class: 'sekolah' },    'private': { title: 'Manajemen Private', class: 'private' },    'admin':   { title: 'Sistem & Admin', class: 'admin' }};// --- 2. CORE LOGIC: MENU GENERATOR ---async function loadDynamicMenus(userRole, userLevelId) {    if (!menuContainer) return;    menuContainer.innerHTML = '<p style="text-align:center; color:#666;">Memuat menu...</p>';    try {        // A. Ambil semua menu AKTIF dari database        const { data: allMenus, error } = await supabase            .from('app_menus')            .select('*')            .eq('is_active', true)            .order('order_index', { ascending: true });        if (error) throw error;        // B. FILTERING (THE GATEKEEPER)        const filteredMenus = allMenus.filter(menu => {            // 1. Cek Role (Wajib)            // Apakah role user saat ini ada di dalam array allowed_roles menu?            const roleMatch = menu.allowed_roles && menu.allowed_roles.includes(userRole);            if (!roleMatch) return false;            // 2. Logic Khusus Super Admin (Bypass Level)            if (userRole === 'super_admin') return true;            // 3. Logic Teacher (Cek Level ID)            if (userRole === 'teacher') {                // Jika allowed_level_ids NULL atau Array Kosong = Menu Umum (Semua Guru Boleh)                if (!menu.allowed_level_ids || menu.allowed_level_ids.length === 0) {                    return true;                }                // Jika ada isinya, Level ID guru harus terdaftar di situ                return menu.allowed_level_ids.includes(userLevelId);            }            return false;        });        // C. RENDER KE LAYAR        renderMenusToHTML(filteredMenus);    } catch (err) {        console.error("Gagal memuat menu:", err);        menuContainer.innerHTML = `<div style="text-align:center; color:red;">Gagal memuat menu.<br><small>${err.message}</small></div>`;    }}function renderMenusToHTML(menus) {    menuContainer.innerHTML = '';        if (menus.length === 0) {        menuContainer.innerHTML = '<p style="text-align:center;">Tidak ada menu yang tersedia untuk akun ini.</p>';        return;    }    // Kelompokkan menu berdasarkan category    const grouped = {};    menus.forEach(menu => {        if (!grouped[menu.category]) grouped[menu.category] = [];        grouped[menu.category].push(menu);    });    // Urutan render kategori    const categoryOrder = ['sekolah', 'private', 'admin'];    categoryOrder.forEach(catKey => {        const items = grouped[catKey];        if (!items || items.length === 0) return; // Skip jika grup kosong        const config = CATEGORY_MAP[catKey] || { title: 'Lainnya', class: 'private' };        // 1. Buat Wrapper Grup        const groupDiv = document.createElement('div');        groupDiv.className = `menu-group-container group-${config.class}`;        // 2. Buat Judul Grup        const titleEl = document.createElement('h2');        titleEl.className = `group-label label-${config.class}`;        titleEl.textContent = config.title;        groupDiv.appendChild(titleEl);        // 3. Buat Grid Container        const gridDiv = document.createElement('div');        gridDiv.className = 'nav-grid-custom';        // 4. Buat Kartu Menu        items.forEach(item => {            const card = document.createElement('div');            card.className = 'nav-card';                        // Render Icon (jika ada) + Judul            if (item.icon_class) {                card.innerHTML = `<i class="${item.icon_class}"></i><span>${item.title}</span>`;            } else {                card.textContent = item.title;            }            // Event Click            card.addEventListener('click', () => {                if (item.route) {                    window.location.href = item.route;                } else {                    alert("Menu ini belum memiliki link tujuan.");                }            });            gridDiv.appendChild(card);        });        groupDiv.appendChild(gridDiv);        menuContainer.appendChild(groupDiv);    });}// --- 3. LOGIKA SEMESTER & STATS (Legacy but Needed) ---function updateActiveSemester() {    const now = new Date();    const month = now.getMonth() + 1;    const year = now.getFullYear();    let semesterName, academicYear;    if (month >= 7 && month <= 12) {        semesterName = "Semester 1";        academicYear = `${year}/${year + 1}`;    } else {        semesterName = "Semester 2";        academicYear = `${year - 1}/${year}`;    }    localStorage.setItem("activeAcademicYear", academicYear);    localStorage.setItem("activeSemester", semesterName);    if (semesterLabelEl) {        semesterLabelEl.innerHTML = `Periode: <strong>${semesterName} ${academicYear}</strong>`;    }}async function getTableCount(table) {    const { count, error } = await supabase.from(table).select('*', { count: 'exact', head: true });    return error ? 0 : (count ?? 0);}async function refreshStats() {    try {        const [sekolah, kelas, siswa] = await Promise.all([            getTableCount('schools'),            getTableCount('classes'),            getTableCount('students')        ]);        if (statsElements.sekolah) statsElements.sekolah.textContent = sekolah;        if (statsElements.kelas) statsElements.kelas.textContent = kelas;        if (statsElements.siswa) statsElements.siswa.textContent = siswa;    } catch (err) { console.error('Stats error:', err); }}// --- 4. AUTH & INITIALIZATION ---async function initDashboard() {    // A. Cek Session    const { data: { session } } = await supabase.auth.getSession();    if (!session) {        window.location.href = 'index.html';        return;    }    // B. Ambil Detail User (Role & Level ID)    const { data: userProfile, error } = await supabase        .from('user_profiles')        .select('role, level_id')        .eq('id', session.user.id)        .single();    if (error || !userProfile) {        alert("Gagal mengambil data profil user.");        await supabase.auth.signOut();        window.location.href = 'index.html';        return;    }    const { role, level_id } = userProfile;    // C. Security Gatekeeper (Hanya Admin & Teacher)    if (role !== 'super_admin' && role !== 'teacher') {        alert("Akses Ditolak: Dashboard hanya untuk Guru & Admin.");        await supabase.auth.signOut();        window.location.href = 'index.html';        return;    }    // Simpan Role di LocalStorage untuk page lain    localStorage.setItem('user_role', role);    // D. Jalankan Fitur Dashboard    updateActiveSemester();    await refreshStats();        // E. LOAD MENU DINAMIS (Poin Utama)    await loadDynamicMenus(role, level_id);}// Event LogoutlogoutBtn?.addEventListener('click', async () => {    await supabase.auth.signOut();    localStorage.clear();    window.location.href = 'index.html';});// Jalankandocument.addEventListener('DOMContentLoaded', initDashboard);