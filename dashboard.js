/** * Project: Scratch Management Dashboard * Version: 3.2 (UUID Support + Target App Filter) * Description: Navigasi digenerate otomatis berdasarkan Role, Level, dan Target Aplikasi. */import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';import { supabaseUrl, supabaseKey } from './config.js';const supabase = createClient(supabaseUrl, supabaseKey);// --- 1. SELEKTOR ELEMEN ---const statsElements = {    sekolah: document.getElementById('count-sekolah'),    kelas: document.getElementById('count-kelas'),    siswa: document.getElementById('count-siswa')};const logoutBtn = document.getElementById('btn-logout');const semesterLabelEl = document.getElementById('semester-label');const menuContainer = document.getElementById('dynamic-menu-container');// --- 2. CORE LOGIC: MENU GENERATOR ---async function loadDynamicMenus(userRole, userLevelId) {    if (!menuContainer) return;    menuContainer.innerHTML = '<p style="text-align:center; color:#666;">Memuat menu...</p>';    try {        // A. AMBIL KATEGORI (Hanya yang untuk ADMIN atau ALL)        const { data: categories, error: catError } = await supabase            .from('menu_categories')            .select('*')            .in('target_app', ['admin', 'all']) // Filter agar menu "Admin V2" tidak muncul di sini            .order('order_index', { ascending: true });        if (catError) throw catError;        // B. AMBIL SEMUA MENU AKTIF        const { data: allMenus, error: menuError } = await supabase            .from('app_menus')            .select('*')            .eq('is_active', true)            .order('order_index', { ascending: true });        if (menuError) throw menuError;        // C. RENDER (Gabungkan Kategori & Menu)        renderDynamicDashboard(categories, allMenus, userRole, userLevelId);    } catch (err) {        console.error("Gagal memuat menu:", err);        menuContainer.innerHTML = `<div style="text-align:center; color:red;">Gagal memuat menu.<br><small>${err.message}</small></div>`;    }}function renderDynamicDashboard(categories, allMenus, userRole, userLevelId) {    menuContainer.innerHTML = '';    if (categories.length === 0) {        menuContainer.innerHTML = '<p style="text-align:center;">Tidak ada konfigurasi kategori untuk Dashboard Admin.</p>';        return;    }    // Loop setiap Kategori yang diizinkan (Admin/All)    categories.forEach(cat => {                // --- [PERBAIKAN UTAMA] ---        // Filter menggunakan ID (UUID), bukan Text Key lagi.        const categoryMenus = allMenus.filter(m => m.category == cat.id);        // -------------------------        // 2. Filter Permission (Role & Level)        const allowedMenus = categoryMenus.filter(menu => {                        // Cek Role (Parsing JSON dulu karena format di DB adalah string array)            let allowedRoles = [];            try {                allowedRoles = typeof menu.allowed_roles === 'string'                     ? JSON.parse(menu.allowed_roles)                     : menu.allowed_roles;            } catch (e) { allowedRoles = []; }            // Logic Role Check            const roleMatch = Array.isArray(allowedRoles) && allowedRoles.includes(userRole);                        // Jika Super Admin, lolos semua (kecuali jika logic bisnis lain)            if (userRole === 'super_admin') return true;            // Jika tidak match role dan bukan super admin            if (!roleMatch) return false;            // Logic Teacher (Cek Level ID)            if (userRole === 'teacher') {                let allowedLevels = [];                try {                    allowedLevels = typeof menu.allowed_level_ids === 'string'                        ? JSON.parse(menu.allowed_level_ids)                        : menu.allowed_level_ids;                } catch (e) { allowedLevels = []; }                if (!allowedLevels || allowedLevels.length === 0) return true; // Menu Umum                return allowedLevels.includes(userLevelId);            }                        return true; // Untuk role lain (misal admin biasa)        });        // Skip render jika kategori ini kosong untuk user tersebut        if (allowedMenus.length === 0) return;        // 3. Render UI Grup        const groupDiv = document.createElement('div');                // Tentukan style warna berdasarkan key (agar tetap cantik seperti sebelumnya)        let styleClass = 'admin'; // Default abu-abu        if (cat.category_key.includes('sekolah')) styleClass = 'sekolah'; // Biru        else if (cat.category_key.includes('private')) styleClass = 'private'; // Orange                groupDiv.className = `menu-group-container group-${styleClass}`;        // Judul Grup        const titleEl = document.createElement('h2');        titleEl.className = `group-label label-${styleClass}`;        titleEl.textContent = cat.title;         groupDiv.appendChild(titleEl);        // Grid Container        const gridDiv = document.createElement('div');        gridDiv.className = 'nav-grid-custom';        // Render Kartu        allowedMenus.forEach(item => {            const card = document.createElement('div');            card.className = 'nav-card';                        if (item.icon_class) {                card.innerHTML = `<i class="${item.icon_class}"></i><span>${item.title}</span>`;            } else {                card.textContent = item.title;            }            card.addEventListener('click', () => {                if (item.route) window.location.href = item.route;                else alert("Menu ini belum memiliki link tujuan.");            });            gridDiv.appendChild(card);        });        groupDiv.appendChild(gridDiv);        menuContainer.appendChild(groupDiv);    });}// --- 3. LOGIKA SEMESTER & STATS ---function updateActiveSemester() {    const now = new Date();    const month = now.getMonth() + 1;    const year = now.getFullYear();    let semesterName, academicYear;    if (month >= 7 && month <= 12) {        semesterName = "Semester 1";        academicYear = `${year}/${year + 1}`;    } else {        semesterName = "Semester 2";        academicYear = `${year - 1}/${year}`;    }    localStorage.setItem("activeAcademicYear", academicYear);    localStorage.setItem("activeSemester", semesterName);    if (semesterLabelEl) {        semesterLabelEl.innerHTML = `Periode: <strong>${semesterName} ${academicYear}</strong>`;    }}async function getTableCount(table) {    const { count, error } = await supabase.from(table).select('*', { count: 'exact', head: true });    return error ? 0 : (count ?? 0);}async function refreshStats() {    try {        const [sekolah, kelas, siswa] = await Promise.all([            getTableCount('schools'),            getTableCount('classes'),            getTableCount('students')        ]);        if (statsElements.sekolah) statsElements.sekolah.textContent = sekolah;        if (statsElements.kelas) statsElements.kelas.textContent = kelas;        if (statsElements.siswa) statsElements.siswa.textContent = siswa;    } catch (err) { console.error('Stats error:', err); }}// --- 4. AUTH & INITIALIZATION ---const userDisplayNameEl = document.getElementById('user-display-name');const userDisplayRoleEl = document.getElementById('user-display-role');async function initDashboard() {    // 1. Ambil Session Auth    const { data: { session } } = await supabase.auth.getSession();    if (!session) {        window.location.href = 'index.html';        return;    }    // 2. Ambil Profil Lengkap    const { data: userProfile, error } = await supabase        .from('user_profiles')        .select('name, role, level_id')        .eq('id', session.user.id)        .single();    if (error || !userProfile) {        console.error("Profile Error:", error);        alert("Gagal mengambil data profil.");        await supabase.auth.signOut();        window.location.href = 'index.html';        return;    }    const { name, role, level_id } = userProfile;    // 3. TAMPILKAN NAMA & ROLE    if (userDisplayNameEl) userDisplayNameEl.textContent = name || "User";        if (userDisplayRoleEl) {        userDisplayRoleEl.textContent = role.toUpperCase();        if (role === 'super_admin') {            userDisplayRoleEl.style.background = '#d32f2f';        } else {            userDisplayRoleEl.style.background = '#1976d2';        }    }    // 4. SECURITY CHECK    if (role !== 'super_admin' && role !== 'teacher') {        alert("Akses Ditolak.");        await supabase.auth.signOut();        window.location.href = 'index.html';        return;    }    localStorage.setItem('user_role', role);    // 5. JALANKAN DASHBOARD    updateActiveSemester();    await refreshStats();        // LOAD MENU (Kirim role & level_id)    await loadDynamicMenus(role, level_id);}// --- LOGOUT ---logoutBtn?.addEventListener('click', async () => {    if (confirm("Logout?")) {        await supabase.auth.signOut();        localStorage.clear();        window.location.href = 'index.html';    }});document.addEventListener('DOMContentLoaded', initDashboard);