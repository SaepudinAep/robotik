import { supabase } from "./config.js";let siswaList = [];let selectedPertemuanId = null;let currentTargets = []; // Menyimpan list target (T1, T2) yang aktiflet isEditMode = false;  // Penanda apakah sedang Edit atau Baru// =========================================// üü¢ SEKTOR 1: UI & OPTIONS (ICON BASED)// =========================================// üîπ HEADER KELASasync function renderHeader() {  const classId = localStorage.getItem("activeClassId");  if (!classId) return;  const { data: kelas } = await supabase    .from("classes")    .select(`      name, jadwal,      schools (id, name),      semesters (name),      academic_years (year)    `)    .eq("id", classId)    .single();        if (!kelas) return;  document.getElementById("header-sekolah").textContent = kelas.schools?.name ?? "-";  document.getElementById("header-tahun").textContent = kelas.academic_years?.year ?? "-";  document.getElementById("header-semester").textContent = kelas.semesters?.name ?? "-";  document.getElementById("header-kelas").textContent = kelas.name ?? "-";  document.getElementById("header-jadwal").textContent = kelas.jadwal ?? "-";  localStorage.setItem("activeSchoolId", kelas.schools?.id ?? "");}// üîπ OPSI SIKAPfunction getSikapOptions(selected = "0") {  const options = [    { value: "0", label: "‚ùå" },    { value: "1", label: "ü§ê " },    { value: "2", label: "üôà " },    { value: "3", label: "üôÇ " },    { value: "4", label: "üëÄ " },    { value: "5", label: "üåÄ " }  ];  return options.map(opt => `<option value="${opt.value}" ${opt.value == selected ? "selected" : ""}>${opt.label}</option>`).join("");}// üîπ OPSI FOKUS (Sesuai gaya yang Anda sukai: ‚ùå, üò∂, üôÇ, üî•)function getFokusOptions(selected = "0") {  const options = [    { value: "0", label: "‚ùå" },    { value: "1", label: "üò∂" },    { value: "2", label: "üôÇ" },    { value: "3", label: "üî•" }  ];  return options.map(opt => `<option value="${opt.value}" ${opt.value == selected ? "selected" : ""}>${opt.label}</option>`).join("");}// üîπ OPSI ACHIEVEMENT (Hanya menggunakan ikon Fokus agar tabel tetap ramping)function getAchievementOptions(selected = "0") {  return getFokusOptions(selected);}// =========================================// üü¢ SEKTOR 2: LOGIC TARGET (ACCORDION)// =========================================// Load Saran Autocomplete (Main Achievement)async function loadAchievementSuggestions() {    const { data } = await supabase.from("achievement_sekolah").select("main_achievement");    if(!data) return;    const unique = [...new Set(data.map(d => d.main_achievement))];    const dl = document.getElementById("list-ach-saran");    if(dl) dl.innerHTML = unique.map(t => `<option value="${t}">`).join("");}// Render List Target di Accordionfunction renderTargetListUI() {    const container = document.getElementById("target-list-preview");    if (!currentTargets.length) {        container.innerHTML = '<small style="color:#888;">Belum ada target.</small>';        return;    }    container.innerHTML = currentTargets.map((t, index) => `        <div style="display:flex; justify-content:space-between; align-items:center; background:#fff; border:1px solid #ddd; padding:8px; margin-bottom:5px; border-radius:4px;">            <div>                <strong style="color:#2196F3;">[T${index+1}]</strong>                 <b>${t.main}</b> - ${t.sub}                ${t.id ? '<span style="font-size:0.8em; color:green;">(Tersimpan)</span>' : '<span style="font-size:0.8em; color:orange;">(Baru)</span>'}            </div>            <button type="button" onclick="hapusTarget(${index})" style="border:none; background:none; cursor:pointer; color:red;">                üóëÔ∏è            </button>        </div>    `).join("");}// Fungsi Hapus Target (Global)window.hapusTarget = async (index) => {    const target = currentTargets[index];    if (target.id) {        const confirmDel = confirm(`HAPUS PERMANEN target "${target.main}"?\n\nNilai bintang siswa untuk target ini akan hilang!`);        if (!confirmDel) return;        const { error } = await supabase.from("achievement_kelas").delete().eq("id", target.id);        if (error) return alert("Gagal menghapus: " + error.message);    }    currentTargets.splice(index, 1);    renderTargetListUI();    if (selectedPertemuanId) await initTable(selectedPertemuanId);};// Event: Tambah Target ke List Sementaradocument.getElementById("btn-add-target-ui")?.addEventListener("click", () => {    const mainInp = document.getElementById("input-ach-main");    const subInp = document.getElementById("input-ach-sub");    const main = mainInp.value.trim();    const sub = subInp.value.trim();    if (!main || !sub) return alert("Harap isi Topik Utama dan Detail Target!");    currentTargets.push({ main, sub, id: null });    renderTargetListUI();    subInp.value = "";    mainInp.focus();});// Event: Simpan Target ke Databasedocument.getElementById("btn-save-targets-db")?.addEventListener("click", async () => {    if (!selectedPertemuanId) return alert("‚ùå Simpan/Pilih Pertemuan terlebih dahulu!");    if (currentTargets.length === 0) return alert("List target kosong!");    const classId = localStorage.getItem("activeClassId");    const btn = document.getElementById("btn-save-targets-db");    btn.textContent = "‚è≥ Menyimpan...";    btn.disabled = true;    try {        for (let i = 0; i < currentTargets.length; i++) {            let t = currentTargets[i];            if (t.id) continue;             let masterId;            const { data: exist } = await supabase.from("achievement_sekolah")                .select("id")                .eq("main_achievement", t.main)                .eq("sub_achievement", t.sub)                .maybeSingle();            if (exist) {                masterId = exist.id;            } else {                const { data: newMaster } = await supabase.from("achievement_sekolah")                    .insert({ main_achievement: t.main, sub_achievement: t.sub })                    .select("id")                    .single();                masterId = newMaster.id;            }            const { data: achKelas } = await supabase.from("achievement_kelas")                .insert({                    pertemuan_id: selectedPertemuanId,                    class_id: classId,                    achievement_sekolah_id: masterId                })                .select("id")                .single();                        currentTargets[i].id = achKelas.id;        }        alert("‚úÖ Target berhasil disimpan!");        renderTargetListUI();        await initTable(selectedPertemuanId);     } catch (err) {        console.error(err);        alert("Gagal menyimpan target.");    } finally {        btn.textContent = "üíæ Simpan Target ke Database";        btn.disabled = false;    }});// =========================================// üü¢ SEKTOR 3: TABEL ABSENSI (DYNAMIC COLS)// =========================================async function loadAbsensiData(pertemuanId) {  const { data: absensi } = await supabase    .from("attendance")    .select("student_id, status, sikap, fokus")    .eq("pertemuan_id", pertemuanId);  const { data: targets } = await supabase    .from("achievement_kelas")    .select(`id, achievement_sekolah (main_achievement, sub_achievement)`)    .eq("pertemuan_id", pertemuanId)    .order("id");  const mappedTargets = targets.map(t => ({      id: t.id,      main: t.achievement_sekolah?.main_achievement,      sub: t.achievement_sekolah?.sub_achievement  })) || [];  currentTargets = mappedTargets;   renderTargetListUI();  const { data: scores } = await supabase    .from("achievement_siswa")    .select("student_id, achievement_kelas_id, score")    .eq("pertemuan_id", pertemuanId);  const scoreMap = {};  scores?.forEach(s => {      scoreMap[`${s.student_id}_${s.achievement_kelas_id}`] = s.score;  });  return { absensi: absensi ?? [], targets: mappedTargets, scoreMap };}async function initTable(pertemuanId) {  const classId = localStorage.getItem("activeClassId");  if (!classId) return;  const { data: students } = await supabase    .from("students")    .select("id, name, grade")    .eq("class_id", classId)    .order("grade", { ascending: true })    .order("name", { ascending: true });  if (!students) return;  siswaList = students;  const { absensi, targets, scoreMap } = await loadAbsensiData(pertemuanId);  const table = document.getElementById("absensi-table");  const thead = table.querySelector("thead");  const tbody = table.querySelector("tbody");  // Header dengan lebar pixel (px) agar dropdown ikon tidak melar  let headerHtml = `    <tr>      <th style="width: 40px;">No.</th>      <th>Nama Siswa</th>      <th style="width: 80px;">Status</th>      <th style="width: 60px;">Sikap</th>      <th style="width: 60px;">Fokus</th>  `;    targets.forEach((t, i) => {      headerHtml += `<th style="width: 60px;" title="${t.main} - ${t.sub}">T${i+1}</th>`;  });  headerHtml += `</tr>`;  thead.innerHTML = headerHtml;  tbody.innerHTML = "";  students.forEach((siswa, index) => {    const absen = absensi.find(a => a.student_id === siswa.id);    const status = absen?.status ?? "0";    const sikap = absen?.sikap ?? "3";     const fokus = absen?.fokus ?? "2";     let rowHtml = `      <tr data-student-id="${siswa.id}">        <td>${index + 1}</td>        <td style="text-align: left;">${siswa.name}</td>        <td>          <select class="status-select">            <option value="0" ${status == "0" ? "selected" : ""}>‚¨ú</option>            <option value="1" ${status == "1" ? "selected" : ""}>‚úÖ</option>            <option value="2" ${status == "2" ? "selected" : ""}>‚ùå</option>          </select>        </td>        <td><select class="sikap-select">${getSikapOptions(sikap)}</select></td>        <td><select class="fokus-select">${getFokusOptions(fokus)}</select></td>    `;    // Kolom Dinamis T1, T2... menggunakan ikon Fokus    targets.forEach(t => {        const key = `${siswa.id}_${t.id}`;        const score = scoreMap[key] ?? "0";        rowHtml += `            <td>                <select class="score-select" data-ach-id="${t.id}">                    ${getAchievementOptions(score)}                </select>            </td>        `;    });    rowHtml += `</tr>`;    tbody.insertAdjacentHTML("beforeend", rowHtml);  });  renderLegend(targets);  updateCounterHadir();}function updateCounterHadir() {    const rows = document.querySelectorAll("#absensi-table tbody tr");    let count = 0;    rows.forEach(r => {        if (r.querySelector(".status-select").value === "1") count++;    });    const elHadir = document.getElementById("total-hadir");    if(elHadir) elHadir.textContent = count;}function renderLegend(targets) {    const oldLeg = document.getElementById("target-legend");    if(oldLeg) oldLeg.remove();    if(targets.length === 0) return;    const tableWrapper = document.querySelector(".table-wrapper");    const legendDiv = document.createElement("div");    legendDiv.id = "target-legend";    legendDiv.style.cssText = "margin-top:10px; padding:10px; background:#fff3cd; border:1px solid #ffeeba; border-radius:4px; font-size:0.85em;";    let html = `<strong>üìã Keterangan Target:</strong><ul style="margin:5px 0 0 15px; padding:0;">`;    targets.forEach((t, i) => {        html += `<li><strong>[T${i+1}]</strong> : ${t.main} ‚Äî ${t.sub}</li>`;    });    html += `</ul>`;        legendDiv.innerHTML = html;    tableWrapper.parentNode.insertBefore(legendDiv, tableWrapper.nextSibling);}// =========================================// üü¢ SEKTOR 4: SIMPAN ABSENSI (BUNDLING)// =========================================document.getElementById("simpan-absensi").addEventListener("click", async () => {  if (!selectedPertemuanId) return alert("Pilih Pertemuan dulu!");  const btn = document.getElementById("simpan-absensi");  btn.textContent = "‚è≥ Menyimpan...";  btn.disabled = true;  try {      const { data: pertemuan } = await supabase        .from("pertemuan_kelas").select("tanggal").eq("id", selectedPertemuanId).single();            const tanggal = pertemuan.tanggal;      const classId = localStorage.getItem("activeClassId");      const rows = document.querySelectorAll("#absensi-table tbody tr");      const attendanceUpdates = [];      const scoreUpdates = [];      rows.forEach(row => {        const studentId = row.dataset.studentId;        attendanceUpdates.push({            pertemuan_id: selectedPertemuanId,            student_id: studentId,            status: row.querySelector(".status-select").value,            sikap: row.querySelector(".sikap-select").value,            fokus: row.querySelector(".fokus-select").value,            tanggal: tanggal        });        row.querySelectorAll(".score-select").forEach(sel => {            scoreUpdates.push({                pertemuan_id: selectedPertemuanId,                class_id: classId,                achievement_kelas_id: sel.dataset.achId,                student_id: studentId,                score: sel.value            });        });      });      // Transaksi: Hapus data lama, Masukkan yang baru      await supabase.from("attendance").delete().eq("pertemuan_id", selectedPertemuanId);      await supabase.from("achievement_siswa").delete().eq("pertemuan_id", selectedPertemuanId);      if (attendanceUpdates.length > 0) {          const { error: err1 } = await supabase.from("attendance").insert(attendanceUpdates);          if (err1) throw err1;      }            if (scoreUpdates.length > 0) {          const { error: err2 } = await supabase.from("achievement_siswa").insert(scoreUpdates);          if (err2) throw err2;      }      alert("‚úÖ Absensi & Nilai berhasil disimpan!");  } catch (err) {      console.error(err);      alert("Gagal menyimpan: " + err.message);  } finally {    btn.textContent = "üíæ Simpan Absensi";    btn.disabled = false;  }});// =========================================// üü¢ SEKTOR 5: CARD CLICK (EDIT PERTEMUAN)// =========================================async function tampilkanDaftarMateri() {  const classId = localStorage.getItem("activeClassId");  if (!classId) return;  const { data } = await supabase    .from("pertemuan_kelas")    .select(`      id, tanggal,      materi:materi_id (title),      guru:guru_id (name, id),      asisten:asisten_id (name, id)    `)    .eq("class_id", classId)    .order("tanggal", { ascending: false });  const container = document.getElementById("materi-list");  container.innerHTML = "";  container.className = "materi-list card-grid";   data.forEach(p => {    const tanggal = new Date(p.tanggal).toLocaleDateString("id-ID", { day: "2-digit", month: "short" });    const card = document.createElement("div");    card.className = "card";    card.style.cursor = "pointer";    card.innerHTML = `      <p class="baris-tanggal">        <strong>üìÖ ${tanggal} :</strong> <span class="judul-materi">${p.materi?.title ?? "-"}</span>      </p>      <p class="baris-pengajar">        <span>üë§ ${p.guru?.name ?? "-"}</span> | <span>üë• ${p.asisten?.name ?? "-"}</span>      </p>    `;        card.onclick = () => confirmEditPertemuan(p);    container.appendChild(card);  });}function confirmEditPertemuan(data) {    if(!confirm(`Edit Pertemuan tanggal ${data.tanggal}?\n"${data.materi?.title}"`)) return;    // 1. Isi Form Atas    document.getElementById("materi-date").value = data.tanggal;    document.getElementById("materi-title").value = data.materi?.title || "";    document.getElementById("materi-guru").value = data.guru?.id || "";    document.getElementById("materi-asisten").value = data.asisten?.id || "";    // 2. Aktifkan Mode Update    isEditMode = true;    selectedPertemuanId = data.id;        const form = document.getElementById("materi-form");    form.style.display = "block";    document.getElementById("toggle-materi-form").textContent = "‚àí Tutup Form";    const btnSubmit = form.querySelector("button[type='submit']");    btnSubmit.textContent = "üìù Update Pertemuan";    // Tombol Batal Edit    let btnBatal = document.getElementById("btn-batal-edit");    if(!btnBatal) {        btnBatal = document.createElement("button");        btnBatal.id = "btn-batal-edit";        btnBatal.type = "button";        btnBatal.textContent = "‚ùå Batal";        btnBatal.className = "btn-secondary";        btnBatal.style.marginLeft = "10px";        btnBatal.onclick = resetFormMateri;        form.querySelector(".form-actions").appendChild(btnBatal);    }    // 3. Load Data ke Tabel    document.getElementById("target-container").style.display = "block";    loadAchievementSuggestions();    initTable(data.id);    window.scrollTo({ top: 0, behavior: 'smooth' });}function resetFormMateri() {    isEditMode = false;    selectedPertemuanId = null;    document.getElementById("materi-form").reset();    document.getElementById("materi-form").style.display = "none";    document.getElementById("toggle-materi-form").textContent = "‚ûï Tambah Pertemuan";        const btnSubmit = document.querySelector("#materi-form button[type='submit']");    btnSubmit.textContent = "üíæ Simpan Materi";        const btnBatal = document.getElementById("btn-batal-edit");    if(btnBatal) btnBatal.remove();    currentTargets = [];    renderTargetListUI();}// =========================================// üü¢ SEKTOR 6: FORM SUBMIT & HELPERS// =========================================document.getElementById("materi-form").addEventListener("submit", async (e) => {  e.preventDefault();  const classId = localStorage.getItem("activeClassId");  const schoolId = localStorage.getItem("activeSchoolId");  const tanggal = document.getElementById("materi-date").value;  const title = document.getElementById("materi-title").value.trim();  const guruId = document.getElementById("materi-guru").value;  const asistenId = document.getElementById("materi-asisten").value;  if (!classId || !schoolId || !tanggal || !title || !guruId) {    alert("Mohon lengkapi data.");    return;  }  try {    let { data: materi } = await supabase.from("materi").select("id").eq("title", title).single();    if (!materi) {      const { data: newMateri } = await supabase.from("materi").insert({ title }).select().single();      materi = newMateri;    }    const payload = {      school_id: schoolId,      class_id: classId,      tanggal,      materi_id: materi.id,      guru_id: guruId,      asisten_id: asistenId    };    if (isEditMode && selectedPertemuanId) {        // UPDATE MODE        const { error } = await supabase.from("pertemuan_kelas").update(payload).eq("id", selectedPertemuanId);        if(error) throw error;        alert("‚úÖ Pertemuan berhasil diupdate.");    } else {        // INSERT MODE        const { data: pData, error } = await supabase.from("pertemuan_kelas").insert([payload]).select("id").single();        if(error) throw error;        selectedPertemuanId = pData.id;        await generateAbsensiDefault(selectedPertemuanId, tanggal);        alert("‚úÖ Pertemuan baru berhasil disimpan.");    }    await tampilkanDaftarMateri();    await loadPertemuanOptions();        if(!isEditMode) {        document.getElementById("target-container").style.display = "block";        initTable(selectedPertemuanId);    }  } catch (err) {    alert("Kesalahan: " + err.message);  }});async function generateAbsensiDefault(pertemuanId, tanggal) {    const classId = localStorage.getItem("activeClassId");    const { data: students } = await supabase.from("students").select("id").eq("class_id", classId);    if(students?.length > 0) {        const records = students.map(s => ({            pertemuan_id: pertemuanId,            student_id: s.id,            status: "0", sikap: "0", fokus: "0", tanggal: tanggal        }));        await supabase.from("attendance").insert(records);    }}async function loadPertemuanOptions() {  const classId = localStorage.getItem("activeClassId");  const select = document.getElementById("pertemuan-selector");  select.innerHTML = `<option value="">-- Pilih Pertemuan --</option>`;  const { data } = await supabase.from("pertemuan_kelas").select("id, tanggal, materi (title)").eq("class_id", classId).order("tanggal", { ascending: false });    // LOGIKA AUTO-LOAD PERTEMUAN TERAKHIR  if (data && data.length > 0 && !selectedPertemuanId) {    selectedPertemuanId = data[0].id;    initTable(selectedPertemuanId);  }data.forEach(p => {    // üî™ Surgery: Format tanggal dd mmm (Contoh: 25 Jan)    const tglLabel = new Date(p.tanggal).toLocaleDateString("id-ID", { day: "2-digit", month: "short" });        const option = document.createElement("option");    option.value = p.id;    option.textContent = `${tglLabel} ‚Äî ${p.materi?.title ?? "-"}`;    if(p.id === selectedPertemuanId) option.selected = true;    select.appendChild(option);  });}async function loadGuruDropdowns() {  const { data } = await supabase.from("teachers").select("id, name").order("name");  const gSelect = document.getElementById("materi-guru");  const aSelect = document.getElementById("materi-asisten");  gSelect.innerHTML = `<option value="">-- Pilih Guru --</option>`;  aSelect.innerHTML = `<option value="">-- Pilih Asisten --</option>`;  data.forEach(t => {    const opt = document.createElement("option");    opt.value = t.id; opt.textContent = t.name;    gSelect.appendChild(opt);    aSelect.appendChild(opt.cloneNode(true));  });}// =========================================// üü¢ SEKTOR 7: INITIAL LOAD// =========================================document.getElementById("pertemuan-selector").addEventListener("change", async (e) => {  if (!e.target.value) return;  selectedPertemuanId = e.target.value;  await initTable(selectedPertemuanId);});document.addEventListener("DOMContentLoaded", async () => {  await renderHeader();  await loadGuruDropdowns();  await loadAchievementSuggestions();  await tampilkanDaftarMateri();  await loadPertemuanOptions();   const toggleBtn = document.getElementById("toggle-materi-form");  const form = document.getElementById("materi-form");  toggleBtn.addEventListener("click", () => {    if(isEditMode) resetFormMateri();     const isHidden = form.style.display === "none";    form.style.display = isHidden ? "block" : "none";    toggleBtn.textContent = isHidden ? "‚àí Tutup Form" : "‚ûï Tambah Pertemuan";  });});